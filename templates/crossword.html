{% extends "base.html" %}
{% block body %}
<link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='phoebe.css') }}">

<style>
    /* 10x10 GRID - SQUARED CORNERS */
    .cw-board {
        display: grid;
        grid-template-columns: repeat(10, 45px);
        grid-template-rows: repeat(10, 45px);
        gap: 2px;
        background: #2c3e50;
        border: 3px solid #046271;
        margin: 0 auto;
        width: fit-content;
        border-radius: 0;
    }

    .cw-cell {
        width: 45px;
        height: 45px;
        text-align: center;
        font-weight: bold;
        text-transform: uppercase;
        border: none;
        font-size: 20px;
        background: white;
        transition: all 0.2s ease;
    }
    
    .cw-cell:focus {
        background-color: #fff9c4;
        outline: 2px solid #046271;
    }

    .empty-cell {
        background: #2c3e50;
        width: 45px;
        height: 45px;
        border: none;
    }

    .cw-cell.correct-word {
        background-color: #b8e6ed !important;
        color: #046271 !important;
        font-weight: bold;
    }

    .cw-cell.not-editable {
        background-color: #e9ecef;
        color: #6c757d;
    }

    .cw-sidebar {
        background: white;
        padding: 20px;
        border-radius: 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .partner-info { background: #f0f8ff; border: 2px solid #046271; padding: 10px; margin-bottom: 10px; }
    .partner-link { color: #046271 !important; font-weight: bold; text-decoration: none; }
    .chat-box { flex-grow: 1; border: 1px solid #e9ecef; background: #f8f9fa; padding: 10px; overflow-y: auto; margin-bottom: 10px; max-height: 200px; }
    .msg { margin-bottom: 6px; font-size: 0.9rem; word-wrap: break-word; }
    .msg b { color: #555; margin-right: 4px; }
</style>

<div class="container-fluid mt-3">
    <div class="mb-3">
        <a href="{{ url_for('find_a_friend_hub') }}" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-arrow-left"></i> Back to Hub
        </a>
    </div>
    
    <div class="row">
        <div class="col-md-9 d-flex justify-content-center">
            <div>
                <h4 class="mb-3 text-center">TXT Crossword Puzzle</h4>
                <div class="cw-board">
                    {% for r in range(10) %}
                        {% for c in range(10) %}
                            {% if (r, c) in layout %}
                                <input type="text" 
                                    maxlength="1" 
                                    class="cw-cell" 
                                    id="cell-{{r}}-{{c}}"
                                    data-row="{{r}}"
                                    data-col="{{c}}"
                                    value="{{ current_state.get(r|string + '_' + c|string, '') }}"
                                    autocomplete="off"
                                    onkeydown="handleKey(event, {{r}}, {{c}})"
                                    oninput="handleInput(this, {{r}}, {{c}})">
                            {% else %}
                                <div class="empty-cell"></div>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="cw-sidebar">
                <h5 class="fw-bold">Crossword</h5>
                
                <div class="partner-info">
                    <small class="text-muted">Playing with:</small><br>
                    <a href="{{ url_for('userprofile', username=partner_name) }}" class="partner-link">
                        @{{ partner_name }}
                    </a>
                </div>

                <div class="alert alert-info py-2 small mb-3">
                    Your Role: <strong>{% if my_role == 'p1' %}ACROSS (→){% else %}DOWN (↓){% endif %}</strong>
                </div>

                <hr>
                <div class="mb-3" style="max-height: 200px; overflow-y: auto;">
                    <h6 class="fw-bold small">Your Clues:</h6>
                    <div class="small">
                        {% for clue in my_clues %}
                        <div class="mb-2 p-2 bg-light">
                            <strong>{{ clue.word|length }} letters:</strong> {{ clue.clue }}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <hr>
                <div id="chatSection">
                    <h6 class="fw-bold small mb-2">Team Chat</h6>
                    <div class="chat-box" id="gameChat">
                        {% for msg in chat_history %}
                            <div class="msg"><b>{{ msg.username }}:</b> {{ msg.content }}</div>
                        {% endfor %}
                    </div>
                    <div class="input-group input-group-sm">
                        <input type="text" id="chatInput" class="form-control" placeholder="Type..." onkeypress="if(event.key==='Enter') sendChat()">
                        <button class="btn btn-primary" onclick="sendChat()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    const sessionId = {{ session_id }};
    const myRole = "{{ my_role }}";
    
    // Convert editable cells list to a Set for fast lookup
    const editableCells = new Set();
    {% for r, c in editable_cells %}
        editableCells.add("{{r}}_{{c}}");
    {% endfor %}
    
    const crosswordLayoutData = {{ layout_data|tojson }};
    const allWords = {{ all_words|tojson }}; // Now correctly contains ALL words (e.g. 7 items)
    let completedWords = new Set({{ words_found|tojson }});

    socket.emit('join_game', {session_id: sessionId, game_type: 'crossword'});

    function canEditCell(r, c) {
        return editableCells.has(`${r}_${c}`);
    }

    // STRICT VALIDATION FUNCTION
    function checkWordCompletion() {
        const wordGroups = {};
        
        // 1. Build Word Groups from Layout Data
        // This ensures we check every word defined in the puzzle
        for (let key in crosswordLayoutData) {
            const data = crosswordLayoutData[key];
            const wordId = `${data.word}_${data.direction}`;
            
            if (!wordGroups[wordId]) {
                wordGroups[wordId] = [];
            }
            
            const [r, c] = key.split(',').map(Number);
            wordGroups[wordId].push({
                r: r, 
                c: c, 
                expected: data.letter
            });
        }
        
        let newlyCompleted = false;

        // 2. Check each word group
        for (let wordId in wordGroups) {
            const cells = wordGroups[wordId];
            let isComplete = true;

            // Check every cell in this word
            for (let cellData of cells) {
                const el = document.getElementById(`cell-${cellData.r}-${cellData.c}`);
                if (!el || el.value.toUpperCase() !== cellData.expected.toUpperCase()) {
                    isComplete = false;
                    break; 
                }
            }

            if (isComplete) {
                if (!completedWords.has(wordId)) {
                    completedWords.add(wordId);
                    newlyCompleted = true;
                    console.log("✅ Completed:", wordId);
                }
                
                // Highlight correct word
                cells.forEach(c => {
                    const el = document.getElementById(`cell-${c.r}-${c.c}`);
                    if(el) {
                        el.classList.add('correct-word');
                        el.readOnly = true; 
                    }
                });
            }
        }

        // 3. Check for Global Win
        // Only trigger if ALL defined words are in the completed set
        if (completedWords.size >= allWords.length) {
            showCongratulations();
        }
    }

    window.addEventListener('DOMContentLoaded', function() {
        // Mark non-editable cells visually
        document.querySelectorAll('.cw-cell').forEach(cell => {
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            if (!canEditCell(r, c)) {
                cell.classList.add('not-editable');
            }
        });
        
        // Initial check in case reloading page
        checkWordCompletion();
    });

    function handleKey(e, r, c) {
        const cell = document.getElementById(`cell-${r}-${c}`);
        if (e.key === "Backspace") {
            if (cell.value === "") moveFocus(r, c, -1);
        } else if (e.key === "ArrowRight") {
            e.preventDefault(); focusCell(r, c+1);
        } else if (e.key === "ArrowLeft") {
            e.preventDefault(); focusCell(r, c-1);
        } else if (e.key === "ArrowDown") {
            e.preventDefault(); focusCell(r+1, c);
        } else if (e.key === "ArrowUp") {
            e.preventDefault(); focusCell(r-1, c);
        }
    }

    function handleInput(el, r, c) {
        if (!canEditCell(r, c)) {
            el.value = "";
            alert("This cell is not in your direction!");
            return;
        }
        
        let val = el.value.toUpperCase();
        
        // Wrong letter visual feedback (red flash)
        // Note: We don't clear it immediately to allow trial/error, 
        // but checking strictly in background.
        const key = `${r},${c}`;
        if (crosswordLayoutData[key] && val && val !== crosswordLayoutData[key].letter) {
            el.style.backgroundColor = '#ffcccc';
            setTimeout(() => el.style.backgroundColor = 'white', 500);
        } else {
            el.style.backgroundColor = 'white';
        }
        
        el.value = val;
        
        // Send move to server
        socket.emit('crossword_move', {
            session_id: sessionId, 
            row: r, 
            col: c, 
            letter: val || ''
        });

        // Re-validate entire board
        checkWordCompletion();

        // Auto-advance
        if (val.length === 1) {
            moveFocus(r, c, 1);
        }
    }

    function moveFocus(r, c, direction) {
        let nextR = r, nextC = c;
        if (myRole === 'p1') nextC = c + direction;
        else nextR = r + direction;
        focusCell(nextR, nextC);
    }

    function focusCell(r, c) {
        let el = document.getElementById(`cell-${r}-${c}`);
        if (el && canEditCell(r, c)) el.focus();
    }

    socket.on('update_grid', (data) => {
        let cell = document.getElementById(`cell-${data.row}-${data.col}`);
        if(cell) {
            cell.value = data.letter;
            // Visual flash for update
            cell.style.backgroundColor = '#cce5ff';
            setTimeout(() => {
                const isEditable = canEditCell(data.row, data.col);
                if (!cell.classList.contains('correct-word')) {
                     cell.style.backgroundColor = isEditable ? 'white' : '#e9ecef';
                }
            }, 500);
            
            // Re-validate when partner moves too
            checkWordCompletion();
        }
    });

    function sendChat() {
        let input = document.getElementById('chatInput');
        if(input.value.trim()) {
            const msg = input.value.trim();
            let box = document.getElementById('gameChat');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg';
            msgDiv.innerHTML = `<b>You:</b> ${msg}`;
            box.appendChild(msgDiv);
            box.scrollTop = box.scrollHeight;
            
            socket.emit('game_chat_message', {session_id: sessionId, msg: msg});
            input.value = '';
        }
    }

    socket.on('game_chat_receive', (data) => {
        if (data.user === "{{ session.get('username') }}") return;
        let box = document.getElementById('gameChat');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg';
        msgDiv.innerHTML = `<b>${data.user}:</b> ${data.msg}`;
        box.appendChild(msgDiv);
        box.scrollTop = box.scrollHeight;
    });

    function showCongratulations() {
        if(document.getElementById('winBanner')) return; // Already showing
        
        const banner = document.createElement('div');
        banner.id = 'winBanner';
        banner.className = 'alert alert-success d-flex align-items-center mb-4';
        banner.style.position = 'fixed'; banner.style.top = '20px'; banner.style.left = '50%'; 
        banner.style.transform = 'translateX(-50%)'; banner.style.zIndex = '9999';
        banner.style.backgroundColor = '#b8e6ed'; banner.style.color = '#046271'; banner.style.borderColor = '#046271';
        banner.innerHTML = `<strong>PUZZLE COMPLETE!</strong> Great job!`;
        document.body.appendChild(banner);
        
        fetch("{{ url_for('game_complete', game_type='crossword') }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `session_id=${sessionId}`
        });
        
        document.querySelectorAll('.cw-cell').forEach(cell => cell.readOnly = true);
        
        setTimeout(() => {
            banner.style.opacity = '0';
            setTimeout(() => banner.remove(), 500);
        }, 5000);
    }
</script>
{% endblock %}