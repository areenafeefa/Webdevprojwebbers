{% extends 'base.html' %}

{% block body %}
<link rel="stylesheet" href="{{ url_for('static', filename='jayden.css') }}">
<div style = " overflow-y: hidden;">
<div class='d-flex flex-row col-12' style="height: calc(100vh - 150px); ">

    <div class="col d-flex flex-column" style="height: 100%;">
        <div id="chat-header" class="p-3 border-bottom bg-light d-flex align-items-center">
            {% if recipient %}
                <h5 class="mb-0">{{ recipient.display_name }}</h5>
            {% elif currentGroup %}
                <h5 class="mb-0"><i class="fa fa-users me-2"></i>{{ currentGroup.name }}</h5>
            {% else %}
                <h5 class="mb-0">Select a chat</h5>
            {% endif %}
        </div>

        <div id="chat-box" class="flex-grow-1 p-3 overflow-auto" style="background-color:#e5ddd5;">
            {% if messages %}
                {% for msg in messages %}
                    <div class="mb-2 {% if msg.sender_username == username %}text-end{% else %}text-start{% endif %}">
                        {% if msg.display_name %} <small class="text-muted" style="font-size:0.75rem;">{{ msg.display_name }}</small><br>
                        {% endif %}
                        
                        {% if '[IMAGE]' in msg.content %}
                             <img src="{{ msg.content.replace('[IMAGE]', '') }}" style="max-width:200px; border-radius:8px;">
                        {% else %}
                        <span class="badge chat-bubble {% if msg.sender_username == username %}bg-primary{% else %}bg-secondary{% endif %} c" 
                            style="font-size: 1rem; font-weight: normal; padding: 8px 12px; 
                                    max-width: 200px; display: inline-block; 
                                    word-wrap: break-word; overflow-wrap: break-word;">
                            {{ msg.content }}
                        </span>

                        {% endif %}
                        <div class="text-muted small" style="font-size:0.7rem;">
                            {{ msg.created_at }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center text-muted mt-5">
                    <p>No messages yet. Say hello!</p>
                </div>
            {% endif %}
        </div>

        <div class="p-3 border-top bg-light" style="flex-shrink: 0;">
            <div class="input-group">
                <input type="file" id="imageInput" class="d-none" accept="image/*">
                <button id="image-btn" class="btn btn-outline-secondary" title="Send image" {% if not recipient and not currentGroup %}disabled{% endif %}>
                    <i class="fa fa-image"></i>
                </button>
                <input type="text" id="chat-input" class="form-control" placeholder="Type a message..." {% if not recipient and not currentGroup %}disabled{% endif %}>
                <button id="send-btn" class="btn btn-success" {% if not recipient and not currentGroup %}disabled{% endif %}>Send</button>
            </div>
        </div>
    </div>
    
    <div class="border-end col-lg-3 col-md-5" style="background-color:#f8f9fa; overflow-y:auto; height: 100%;">
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Messages</h5>
            <div>
                <button class="btn btn-sm btn-outline-success me-1" data-bs-toggle="modal" data-bs-target="#createGroupModal" title="Create Group Chat">
                    <i class="fa fa-users"></i>
                </button>
                <button class="btn btn-sm btn-primary" onclick="document.getElementById('contactModal').style.display='block'" title="Find People">
                    <i class="fa fa-plus"></i>
                </button>
            </div>
        </div>
        
        <ul class="list-group list-group-flush" id="chatsList">
            {% if groups %}
                <li class="list-group-item bg-light text-muted small fw-bold">GROUPS</li>
                {% for group in groups %}
                <li class="list-group-item list-group-item-action d-flex align-items-center" 
                    style="cursor:pointer;"
                    onclick="loadGroupChat({{ group.group_id }}, '{{ group.name }}')">
                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2" style="width:35px; height:35px; color:white;">
                        <i class="fa fa-users"></i>
                    </div>
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>{{ group.name }}</strong>
                        </div>
                        <small class="text-muted d-block text-truncate">{{ group.last_message or 'No messages yet' }}</small>
                    </div>
                </li>
                {% endfor %}
            {% endif %}

            <li class="list-group-item bg-light text-muted small fw-bold mt-2">DIRECT MESSAGES</li>
            {% if chats %}
                {% for chat in chats %}
                <li class="list-group-item list-group-item-action d-flex align-items-center {% if recipient and chat.username == recipient.username %}active{% endif %}" 
                    style="cursor:pointer;"
                    onclick="window.location.href='/chat/{{ chat.username }}'">
                    <span class="rounded-circle me-2" 
                          style="width:10px; height:10px; background-color: {% if chat.online %}#0f0{% else %}#ccc{% endif %}; display:inline-block;"></span>
                    <div class="flex-grow-1">
                        <div>{{ chat.display_name }}</div>
                        <small class="text-muted d-block text-truncate">{{ chat.last_message }}</small>
                    </div>
                </li>
                {% endfor %}
            {% else %}
                <li class="list-group-item text-center text-muted py-3">No contacts yet.</li>
            {% endif %}
        </ul>
    </div>

</div>
</div>
<div id="contactModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5);">
    <div style="background-color:#fefefe; margin:10% auto; padding:20px; border:1px solid #888; width:80%; max-width:400px; border-radius:10px;">
        <span onclick="document.getElementById('contactModal').style.display='none'" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
        <h3 style="margin-top:0;">Find People</h3>
        <input type="text" id="userSearchInput" placeholder="Type a username..." style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;">
        <div id="searchResults" style="max-height:300px; overflow-y:auto; border-top:1px solid #eee;">
            <div style="padding:10px; color:#999; text-align:center;">Start typing to search...</div>
        </div>
    </div>
</div>

<div class="modal fade" id="createGroupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Group Chat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Group Name</label>
                    <input type="text" id="groupName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <input type="text" id="groupDescription" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Select Members</label>
                    <div id="groupMembers" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="createGroupBtn">Create</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
const chatBox = document.getElementById('chat-box');
// Handle Recipient vs Group state
let recipient = "{{ recipient.username if recipient else '' }}";
let currentGroupId = null;

// === GROUP CHAT LOGIC ===
async function loadGroupChat(groupId, groupName) {
    try {
        const response = await fetch(`/api/group/${groupId}/messages`);
        const data = await response.json();
        
        if (data.messages) {
            recipient = null; // Clear DM recipient
            currentGroupId = groupId; // Set group ID
            
            // Update Header
            document.getElementById('chat-header').innerHTML = `<h5 class="mb-0"><i class="fa fa-users me-2"></i>${groupName}</h5>`;
            
            // Clear and Fill Messages
            chatBox.innerHTML = '';
            data.messages.forEach(msg => {
                // PASS TIMESTAMP HERE
                appendMessageToUI(msg.sender_username, msg.content, msg.display_name, msg.created_at);
            });
            
            // Enable Inputs
            enableInputs();
            scrollToBottom();
            
            // Join Socket Room
            socket.emit('join_group', {group_id: groupId});
        }
    } catch (error) {
        console.error("Error loading group:", error);
    }
}

// === UTILS ===
function appendMessageToUI(sender, content, displayName, timestamp) {
    const div = document.createElement('div');
    div.className = `mb-2 ${sender === "{{ session['username'] }}" ? 'text-end' : 'text-start'}`;
    
    let innerHTML = '';
    // 1. Add Sender Name (for groups)
    if (displayName && sender !== "{{ session['username'] }}") {
        innerHTML += `<small class="text-muted" style="font-size:0.75rem;">${displayName}</small><br>`;
    }
    
    // 2. Add Content
    if (content.startsWith('[IMAGE]')) {
        innerHTML += `<img src="${content.replace('[IMAGE]', '')}" style="max-width:200px; border-radius:8px;">`;
    } else {
        const bgClass = sender === "{{ session['username'] }}" ? 'bg-primary' : 'bg-secondary';
        innerHTML += `<span class="badge ${bgClass}" style="font-size: 1rem; font-weight: normal; padding: 8px 12px;">${content}</span>`;
    }

    // 3. Add Timestamp (UPDATED)
    let timeString = '';
    if (timestamp) {
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) {
             // If valid string from DB but parsing failed or different format, just use as is
            timeString = timestamp; 
        } else {
            timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    } else {
        // Fallback for live messages without timestamp data
        timeString = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    innerHTML += `<div class="text-muted small" style="font-size:0.7rem; margin-top:2px;">${timeString}</div>`;
    
    div.innerHTML = innerHTML;
    chatBox.appendChild(div);
}

function enableInputs() {
    document.getElementById('chat-input').disabled = false;
    document.getElementById('send-btn').disabled = false;
    document.getElementById('image-btn').disabled = false;
}

function scrollToBottom(){
    chatBox.scrollTop = chatBox.scrollHeight;
}
scrollToBottom();

// === SEARCH USERS FOR CONTACTS ===
let searchTimeout = null;
document.getElementById('userSearchInput').addEventListener('input', function(e) {
    const query = e.target.value;
    const resultsDiv = document.getElementById('searchResults');
    
    if (searchTimeout) clearTimeout(searchTimeout);
    if (query.length < 1) { resultsDiv.innerHTML = '<div class="p-2 text-center text-muted">Type to search...</div>'; return; }
    
    resultsDiv.innerHTML = '<div class="p-2 text-center">Searching...</div>';
    
    searchTimeout = setTimeout(() => {
        fetch(`/api/all-users?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                resultsDiv.innerHTML = '';
                if(data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        resultsDiv.innerHTML += `
                            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                <div><strong>${user.display_name}</strong><br><small class="text-muted">@${user.username}</small></div>
                                <button class="btn btn-sm btn-primary" onclick="addContact('${user.username}')">Add</button>
                            </div>`;
                    });
                } else {
                    resultsDiv.innerHTML = '<div class="p-2 text-center text-muted">No users found</div>';
                }
            });
    }, 300);
});

function addContact(username) {
    fetch('/api/add-contact', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({contact_username: username})
    }).then(res => res.json()).then(data => {
        if(data.success) { alert('Added!'); location.reload(); }
        else { alert(data.error); }
    });
}

// === CREATE GROUP LOGIC ===
// Load users when modal opens
document.getElementById('createGroupModal').addEventListener('show.bs.modal', () => {
    fetch('/api/all-users').then(res => res.json()).then(data => {
        const container = document.getElementById('groupMembers');
        container.innerHTML = '';
        if(data.users) {
            data.users.forEach(user => {
                container.innerHTML += `
                    <div class="form-check">
                        <input class="form-check-input group-member" type="checkbox" value="${user.username}" id="chk_${user.username}">
                        <label class="form-check-label" for="chk_${user.username}">${user.display_name}</label>
                    </div>`;
            });
        }
    });
});

document.getElementById('createGroupBtn').addEventListener('click', () => {
    const name = document.getElementById('groupName').value;
    const desc = document.getElementById('groupDescription').value;
    const members = Array.from(document.querySelectorAll('.group-member:checked')).map(cb => cb.value);
    
    fetch('/api/create-group', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({group_name: name, description: desc, member_ids: members})
    }).then(res => res.json()).then(data => {
        if(data.success) { alert('Group created!'); location.reload(); }
        else { alert(data.error); }
    });
});

// === SENDING MESSAGES ===
document.getElementById('send-btn').addEventListener('click', () => {
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if(!msg) return;
    
    if(currentGroupId) {
        socket.emit('send_group_message', {msg: msg, group_id: currentGroupId});
    } else if(recipient) {
        socket.emit('send_message', {msg: msg, recipient: recipient});
    }
    input.value = '';
});

// === IMAGE UPLOADING (Added back) ===
document.getElementById('image-btn').addEventListener('click', () => document.getElementById('imageInput').click());
document.getElementById('imageInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('image', file);
    if (currentGroupId) formData.append('group_id', currentGroupId);
    else if (recipient) formData.append('recipient', recipient);

    try {
        const response = await fetch('/api/send-image', {method: 'POST', body: formData});
        const data = await response.json();
        if (response.ok) {
            // Send timestamp as new Date() for immediate display
            appendMessageToUI("{{ session['username'] }}", data.image_url ? `[IMAGE]${data.image_url}` : `[IMAGE]${file.name}`, null, new Date());
            scrollToBottom();
        }
    } catch(e) { alert('Error sending image'); }
});


// === SOCKET LISTENERS ===
socket.on('message', data => {
    if(recipient === data.user || data.user === "{{ session['username'] }}") {
        // Use new Date() for live timestamp
        appendMessageToUI(data.user, data.msg, null, new Date());
        scrollToBottom();
    }
});

socket.on('group_message', data => {
    if(currentGroupId === data.group_id) {
        // Use timestamp from server or fallback to new Date()
        appendMessageToUI(data.user, data.msg, data.user, data.timestamp || new Date()); 
        scrollToBottom();
    }
});
</script>
{% endblock %}