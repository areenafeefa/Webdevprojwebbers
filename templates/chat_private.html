{% extends 'base.html' %}

{% block body %}

<style>
    /* WhatsApp-like Styles */
    #maincontent {
        padding: 0 !important;
    }

    /* Remove base template padding */
    #layoutWrapper {
        height: 100vh;
        overflow: hidden;
    }

    /* Ensure full height */

    .chat-bubble {
        border-radius: 7.5px;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        width: fit-content;
        min-width: 50px;
    }

    /* My Message (Green) */
    .chat-bubble.me {
        background-color: #d9fdd3;
        color: #111b21;
    }

    /* Their Message (White) */
    .chat-bubble.them {
        background-color: #ffffff;
        color: #111b21;
    }
</style>

<div style="overflow-y: hidden;">
    <div class='d-flex flex-row col-12' style="height: calc(100vh - 70px);">

        <div class="border-end col-lg-3 col-md-5" style="background-color:#f8f9fa; overflow-y:auto; height: 100%;">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Messages</h5>
                <div>

<button class="btn btn-sm btn-success me-1" data-bs-toggle="modal"
                        data-bs-target="#createGroupModal" title="Create Group Chat"
    style="background-color: #198754 !important; border-color: #198754 !important; color: white !important;">
    <i class="fa fa-users"></i>
</button>
<button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#contactModal"
                        title="Find People"
    style="background-color: #0d6efd !important; border-color: #0d6efd !important; color: white !important;">
    <i class="fa fa-plus"></i>
</button>
                </div>
            </div>

            <ul class="list-group list-group-flush" id="chatsList">
                {% if groups %}
                <li class="list-group-item bg-light text-muted small fw-bold">GROUPS</li>
                {% for group in groups %}
                <li class="list-group-item list-group-item-action d-flex align-items-center" style="cursor:pointer;"
                    onclick="loadGroupChat({{ group.group_id }}, '{{ group.name }}')">
                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2"
                        style="width:35px; height:35px; color:white;">
                        <i class="fa fa-users"></i>
                    </div>
                    <div class="flex-grow-1" style="min-width: 0;">
                        <div class="d-flex align-items-center">
                            <strong class="me-2">{{ group.name }}</strong>
                            <button class="btn btn-sm btn-info rounded-circle text-white"
                                style="width: 20px; height: 20px; padding: 0; font-size: 10px; line-height: 20px;"
                                onclick="event.stopPropagation(); loadGroupInfo({{ group.group_id }});"
                                title="Group Members">
                                <i class="fa fa-info"></i>
                            </button>
             </div>
                        <small class="text-muted d-block text-truncate mt-1">{{ group.last_message or 'No messages yet'
                            }}</small>
                    </div>
                </li>
                {% endfor %}
                {% endif %}



                <li class="list-group-item bg-light text-muted small fw-bold mt-2">DIRECT MESSAGES</li>
                {% if chats %}
                {% for chat in chats %}
                <li class="list-group-item list-group-item-action d-flex align-items-center {% if recipient and chat.username == recipient.username %}active{% endif %}"
                    style="cursor:pointer;" onclick="window.location.href='/chat/{{ chat.username }}'">
                    <span class="rounded-circle me-2"
                        style="width:10px; height:10px; background-color: {% if chat.online %}#0f0{% else %}#ccc{% endif %}; display:inline-block;"></span>
                    <div class="flex-grow-1">
                        <div>{{ chat.display_name }}</div>
                        <small class="text-muted d-block text-truncate">{{ chat.last_message }}</small>
                    </div>
                </li>
                {% endfor %}
                {% else %}
                <li class="list-group-item text-center text-muted py-3">No contacts yet.</li>
                {% endif %}
            </ul>
        </div>

        <div class="col d-flex flex-column" style="height: 100%;">
            <div id="chat-header" class="p-3 border-bottom bg-light d-flex justify-content-between align-items-center">
                <!-- VERSION CHECK -->

                {% if recipient %}
                <div class="d-flex flex-column">
                    <h5 class="mb-0">{{ recipient.display_name }}</h5>
                    <div class="text-muted d-flex align-items-center gap-1" style="font-size: 0.8rem;">
                        <i class="fa fa-lock" style="font-size: 0.7rem;"></i> <span>End-to-end encrypted</span>
                    </div>
                </div>
<!-- Friend Info -->

                <div>
<button class="btn btn-sm rounded-circle" style="background-color: #0d6efd !important; color: white !important;"                     data-bs-toggle="modal" data-bs-target="#friendInfoModal">
    <i class="fa fa-info" ></i>
</button>
                    <script>console.log("FEATURE DEBUG: Info Button Rendered");</script>
                </div>
                {% elif currentGroup %}
                <div class="d-flex align-items-center">
                    <h5 class="mb-0 me-3"><i class="fa fa-users me-2"></i>{{ currentGroup.name }}</h5>
<!-- Group Info -->
<button class="btn btn-sm btn-primary rounded-circle" data-bs-toggle="modal"
                        data-bs-target="#groupInfoModal" title="Group Info" style="background-color: #0d6efd !important; color: white !important;">
    <i class="fa fa-info"></i>
</button>
                </div>
                {% else %}
                <h5 class="mb-0">Select a chat</h5>
                {% endif %}
            </div>

            <div id="chat-box" class="flex-grow-1 p-3 overflow-auto" style="background-color:#e5ddd5;">
                {% if messages %}
                {% for msg in messages %}
                <div class="mb-2 {% if msg.sender_username == username %}text-end{% else %}text-start{% endif %}"
                    id="msg-{{ msg.message_id }}">
                    {% if msg.display_name and msg.sender_username != username %}
                    <small class="text-muted" style="font-size:0.75rem;">{{ msg.display_name }}</small><br>
                    {% endif %}

                    {% if '[IMAGE]' in msg.content %}
                    <img src="{{ msg.content.replace('[IMAGE]', '') }}"
                        style="max-width:200px; border-radius:8px; cursor:pointer;"
                        onclick="confirmDelete(this, {{ msg.message_id }}, '{{ msg.sender_username }}')">
                    {% else %}
                    <span class="badge chat-bubble {% if msg.sender_username == username %}me{% else %}them{% endif %}"
                        style="font-size: 1rem; font-weight: normal; padding: 8px 12px; 
                                    max-width: 60%; display: inline-block; text-align: left;
                                    white-space: pre-wrap !important; word-wrap: break-word; overflow-wrap: break-word; word-break: break-all; cursor:pointer;"
                        onclick="confirmDelete(this, {{ msg.message_id }}, '{{ msg.sender_username }}')">
                        {{ msg.content }}
                    </span>

                    {% endif %}
                    <div class="text-muted small" style="font-size:0.7rem;">
                        {{ msg.created_at }}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center text-muted mt-5">
                    <p>No messages yet. Say hello!</p>
                </div>
                {% endif %}
            </div>

            <div class="p-3 border-top bg-light" style="flex-shrink: 0;">
                <div class="input-group">
                    <input type="file" id="imageInput" class="d-none" accept="image/*">
                    <button id="image-btn" class="btn btn-outline-secondary" title="Send image" {% if not recipient and
                        not currentGroup %}disabled{% endif %}>
                        <i class="fa fa-image"></i>
                    </button>
                    <input type="text" id="chat-input" class="form-control" placeholder="Type a message..." {% if not
                        recipient and not currentGroup %}disabled{% endif %}>
                    <button id="send-btn" class="btn btn-success" {% if not recipient and not currentGroup %}disabled{%
                        endif %}>Send</button>
                </div>
            </div>
        </div>



    </div>
</div>


<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io();
    const chatBox = document.getElementById('chat-box');
    // Handle Recipient vs Group state
    let recipient = "{{ recipient.username if recipient else '' }}";
    let recipientId = "{{ recipient.user_id if recipient else '' }}";
    let currentGroupId = null;
    const currentUser = "{{ session['username'] }}";



    // Simplified append for plain text
    function appendMessageToUI(sender, content, displayName, timestamp, isEncrypted, messageId) {
        const div = document.createElement('div');
        div.className = `mb-2 ${sender === "{{ session['username'] }}" ? 'text-end' : 'text-start'}`;
        if (messageId) div.id = `msg-${messageId}`;

        let innerHTML = '';
        // 1. Add Sender Name (for groups)
        if (displayName && sender !== "{{ session['username'] }}") {
            innerHTML += `<small class="text-muted" style="font-size:0.75rem;">${displayName}</small><br>`;
        }

        const clickHandler = messageId ? `onclick="confirmDelete(this, ${messageId}, '${sender}')"` : '';
        const cursorStyle = messageId ? 'cursor:pointer;' : '';

        // 2. Add Content
        if (content.startsWith('[IMAGE]')) {
            innerHTML += `<img src="${content.replace('[IMAGE]', '')}" style="max-width:200px; border-radius:8px; ${cursorStyle}" ${clickHandler}>`;
        } else {
            const bubbleClass = sender === "{{ session['username'] }}" ? 'me' : 'them';
            // Always render as plain text, ignoring isEncrypted flag for display purposes
            // (Old encrypted messages will show as raw text, which is expected behavior for removal)
            innerHTML += `<span class="badge chat-bubble ${bubbleClass}" style="font-size: 1rem; font-weight: normal; padding: 8px 12px; max-width: 60%; display: inline-block; text-align: left; white-space: pre-wrap !important; word-wrap: break-word; overflow-wrap: break-word; word-break: break-all; ${cursorStyle}" ${clickHandler}>${content}</span>`;
        }

        // 3. Add Timestamp
        let timeString = '';
        if (timestamp) {
            const date = new Date(timestamp);
            timeString = isNaN(date.getTime()) ? timestamp : date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else {
            timeString = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        innerHTML += `<div class="text-muted small" style="font-size:0.7rem; margin-top:2px;">${timeString}</div>`;

        div.innerHTML = innerHTML;
        chatBox.appendChild(div);
        // Remove placeholder if exists
        const ph = document.getElementById('no-msg-placeholder');
        if (ph) ph.remove();
    }


    // === GROUP CHAT LOGIC ===
    async function loadGroupChat(groupId, groupName) {
        // Current E2EE Implementation does NOT support Groups (Complex key management required)
        // Falling back to plain text for groups
        try {
            const response = await fetch(`/api/group/${groupId}/messages`);
            const data = await response.json();

            if (data.messages) {
                recipient = null;
                currentGroupId = groupId;

                document.getElementById('chat-header').innerHTML = `<h5 class="mb-0"><i class="fa fa-users me-2"></i>${groupName}</h5>`;
                chatBox.innerHTML = '';
                data.messages.forEach(msg => {
                    appendMessageToUI(msg.sender_username, msg.content, msg.display_name, msg.created_at, msg.is_encrypted, msg.message_id);
                });
                enableInputs();
                scrollToBottom();
                socket.emit('join_group', { group_id: groupId });
            }
        } catch (error) { console.error("Error loading group:", error); }
    }

    // === SENDING MESSAGES ===
    document.getElementById('send-btn').addEventListener('click', async () => {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim();
        if (!msg) return;

        if (currentGroupId) {
            // GROUP CHAT
            socket.emit('send_group_message', { msg: msg, group_id: currentGroupId, is_encrypted: 0 });
            input.value = '';
        } else if (recipient) {
            // DM: Plain Text
            socket.emit('send_message', { msg: msg, recipient: recipient, is_encrypted: 0 });

            // Optimistic UI update REMOVED to rely on socket echo which contains the message_id for deletion
            input.value = '';
        }
    });

    // === SOCKET LISTENERS ===
    socket.on('message', data => {
        if (recipient === data.user || data.user === currentUser) {
            // If it's my own message coming back from server, ignore if I already optimistic-appended it?
            // But server ack is good.
            // For simplicity, if it's from ME, distinct treatment? 
            // SocketIO reflects back to sender too.
            // if (data.user === currentUser) return; // Ignore echo if optimistic update used -> WE WANT ECHO for ID

            appendMessageToUI(data.user, data.msg, null, new Date(), data.is_encrypted, data.message_id);
            scrollToBottom();
        }
    });

    socket.on('group_message', data => {
        if (currentGroupId === data.group_id) {
            // if (data.user === currentUser) return; // We want echo for ID
            appendMessageToUI(data.user, data.msg, data.user, data.timestamp || new Date(), data.is_encrypted, data.message_id);
            scrollToBottom();
        }
    });

    // === DELETION LOGIC ===
    socket.on('message_deleted', data => {
        const el = document.getElementById(`msg-${data.message_id}`);
        if (el) el.remove();
    });

    function confirmDelete(el, messageId, sender) {
        if (sender !== currentUser) return; // Can only delete own messages

        if (confirm("Delete this message?")) {
            fetch(`/api/message/${messageId}/delete`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.error) alert(data.error);
                })
                .catch(err => console.error(err));
        }
    }

    // Utils
    function enableInputs() {
        document.getElementById('chat-input').disabled = false;
        document.getElementById('send-btn').disabled = false;
        document.getElementById('image-btn').disabled = false;
    }
    function scrollToBottom() { chatBox.scrollTop = chatBox.scrollHeight; }

    // Init
    scrollToBottom();
    init_game_tables(); // Assuming this was supposed to be initCrypto? Replaced effectively with nothing or generic init if needed.
    // Actually initCrypto was for keys. We can just ignore/remove it.
    scrollToBottom();


    // ... Search/Modal logic preserved ...


    // === CREATE GROUP LOGIC ===
    // Populate members list for group creation
    // === CREATE GROUP LOGIC removed from here and moved to HTML ===

    // === GROUP INFO MODAL (SIDEBAR) ===
    async function loadGroupInfo(groupId) {
        const modalEl = document.getElementById('genericGroupInfoModal');
        const modal = new bootstrap.Modal(modalEl);

        // Reset UI
        document.getElementById('genericGroupName').innerText = 'Loading...';
        document.getElementById('genericGroupDesc').innerText = '';
        document.getElementById('genericMemberCount').innerText = '0';
        document.getElementById('genericMemberList').innerHTML = '<div class="text-center text-muted py-3"><i class="fa fa-spinner fa-spin"></i> Loading...</div>';

        modal.show();

        try {
            const response = await fetch(`/api/group/${groupId}/messages`);
            const data = await response.json();

            if (data.group) {
                document.getElementById('genericGroupName').innerText = data.group.name;
                document.getElementById('genericGroupDesc').innerText = data.group.description || 'No description';

                // Members
                if (data.members && data.members.length > 0) {
                    document.getElementById('genericMemberCount').innerText = data.members.length;
                    const listHtml = data.members.map(m => `
                        <div class="list-group-item d-flex align-items-center">
                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3"
                                style="width:36px; height:36px; color:white; font-weight:bold;">
                                ${m.display_name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="fw-bold">${m.display_name}</div>
                                <small class="text-muted">@${m.username}</small>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('genericMemberList').innerHTML = listHtml;
                } else {
                    document.getElementById('genericMemberList').innerHTML = '<div class="text-muted text-center py-3">No members found.</div>';
                }
            }
        } catch (e) {
            console.error("Error fetching group info:", e);
            document.getElementById('genericMemberList').innerHTML = '<div class="text-danger text-center py-3">Error loading info.</div>';
        }
    }

</script>

<!-- Consolidated Search Script -->
<script>
    let searchTimeout = null;

    window.performSearch = function (query) {
        const searchResults = document.getElementById('searchResults');
        if (!searchResults) return;

        query = query ? query.trim() : "";

        if (searchTimeout) clearTimeout(searchTimeout);

        searchResults.innerHTML = '<div style="padding:10px; color:#666; text-align:center;"><i class="fa fa-spinner fa-spin"></i> Searching...</div>';

        searchTimeout = setTimeout(async () => {
            try {
                const res = await fetch(`/api/search_users?q=${encodeURIComponent(query)}`);

                if (res.ok) {
                    const users = await res.json();

                    if (searchResults) {
                        if (users.length === 0) {
                            searchResults.innerHTML = `<div style="padding:10px; color:#999; text-align:center;">No users found matching "${query}".</div>`;
                        } else {
                            searchResults.innerHTML = '';
                            if (!query) {
                                const header = document.createElement('div');
                                header.innerHTML = '<small class="text-muted ms-2">Suggested Users</small>';
                                searchResults.appendChild(header);
                            }

                            users.forEach(user => {
                                const div = document.createElement('div');
                                div.className = "d-flex justify-content-between align-items-center p-2 border-bottom";

                                const initial = user.display_name.charAt(0).toUpperCase();

                                let actionHtml = '';
                                if (user.is_friend) {
                                    actionHtml = `<button class="btn btn-sm btn-success rounded-pill" onclick="window.location.href='/chat/${user.username}'"><i class="fa fa-comment"></i> Chat</button>`;
                                } else if (user.request_sent) {
                                    actionHtml = `<button class="btn btn-sm btn-secondary rounded-pill" disabled><i class="fa fa-clock-o"></i> Sent</button>`;
                                } else if (user.request_received) {
                                    actionHtml = `<a href="/notifications" class="btn btn-sm btn-primary rounded-pill"><i class="fa fa-reply"></i> Respond</a>`;
                                } else {
                                    actionHtml = `<button class="btn btn-sm btn-outline-primary rounded-pill" onclick="sendFriendRequest(this, '${user.username}')"><i class="fa fa-user-plus"></i> Add</button>`;
                                }

                                div.innerHTML = `
                                    <div class="d-flex align-items-center">
                                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                             style="width:40px; height:40px; color:white; font-weight:bold;">${initial}</div>
                                        <div>
                                            <div class="fw-bold">${user.display_name}</div>
                                            <div class="text-muted small">@${user.username}</div>
                                        </div>
                                    </div>
                                    <div>${actionHtml}</div>
                                `;
                                searchResults.appendChild(div);
                            });
                        }
                    }
                } else {
                    if (searchResults) searchResults.innerHTML = `<div style="padding:10px; color:red; text-align:center;">Server Error: ${res.status}</div>`;
                }
            } catch (e) {
                console.error("Search failed", e);
                if (searchResults) searchResults.innerHTML = '<div style="padding:10px; color:red; text-align:center;">Error searching users.</div>';
            }
        }, 300);
    };

    // Auto-attach listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Button
        const btn = document.getElementById('manualSearchBtn');
        if (btn) {
            btn.onclick = function () {
                const input = document.getElementById('userSearchInput');
                if (input) performSearch(input.value);
            };
        }
        // Input
        const input = document.getElementById('userSearchInput');
        if (input) {
            input.oninput = function () { performSearch(this.value); };
        }

        // Create Group Button
        const createGroupBtn = document.getElementById('createGroupBtn');
        if (createGroupBtn) {
            createGroupBtn.addEventListener('click', async () => {
                const nameInput = document.getElementById('groupName');
                const descInput = document.getElementById('groupDescription');
                const membersDiv = document.getElementById('groupMembers');

                if (!nameInput.value.trim()) {
                    alert('Please enter a group name.');
                    return;
                }

                // Get selected usernames
                const checkboxes = membersDiv.querySelectorAll('input[type="checkbox"]:checked');
                const memberUsernames = Array.from(checkboxes).map(cb => cb.value);

                if (memberUsernames.length === 0) {
                    alert('Please select at least one member.');
                    return;
                }

                createGroupBtn.disabled = true;
                createGroupBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Creating...';

                try {
                    const res = await fetch('/api/create-group', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            group_name: nameInput.value.trim(),
                            description: descInput.value.trim(),
                            member_ids: memberUsernames // Sending usernames based on API code reading
                        })
                    });

                    const data = await res.json();

                    if (res.ok) {
                        // Success - Reload to show new group
                        window.location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to create group'));
                        createGroupBtn.disabled = false;
                        createGroupBtn.innerHTML = 'Create';
                    }
                } catch (e) {
                    console.error(e);
                    alert('An error occurred.');
                    createGroupBtn.disabled = false;
                    createGroupBtn.innerHTML = 'Create';
                }
            });
        }
    });

    // Helper function to send friend request
    window.sendFriendRequest = async (btn, username) => {
        btn.disabled = true;
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
        try {
            const res = await fetch(`/friend/request/${username}`, { method: 'POST' });
            if (res.ok) {
                btn.className = "btn btn-sm btn-secondary rounded-pill";
                btn.innerHTML = '<i class="fa fa-check"></i> Sent';
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa fa-exclamation-triangle"></i> Retry';
            }
        } catch (e) {
            console.error(e);
            btn.disabled = false;
            btn.innerHTML = '<i class="fa fa-exclamation-triangle"></i> Retry';
        }
    };
</script>


{% endblock %}

{% block modals %}
<!-- Contact Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Find People</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="userSearchInput" class="form-control" placeholder="Type a username..."
                        onkeyup="if(event.key==='Enter') performSearch(this.value)">
                    <button class="btn btn-primary" type="button" id="manualSearchBtn"
                        onclick="const val = document.getElementById('userSearchInput').value; performSearch(val);"><i
                            class="fa fa-search"></i></button>
                </div>

                <div id="searchResults" style="max-height:300px; overflow-y:auto; border-top:1px solid #eee;">
                    <div style="padding:10px; color:#999; text-align:center;">Start typing to search...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Group Chat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Group Name</label>
                    <input type="text" id="groupName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <input type="text" id="groupDescription" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Select Members</label>
                    <div id="groupMembers" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                        {% if friends %}
                        {% for friend in friends %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="{{ friend.username }}"
                                id="member_{{ friend.user_id }}">
                            <label class="form-check-label d-flex align-items-center" for="member_{{ friend.user_id }}"
                                style="cursor:pointer;">
                                <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2"
                                    style="width:30px; height:30px; color:white; font-size: 0.8em;">{{
                                    friend.display_name[0]|upper }}</div>
                                <div>
                                    <div>{{ friend.display_name }}</div>
                                    <small class="text-muted">@{{ friend.username }}</small>
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-muted small">No friends found. Add friends first!</div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="createGroupBtn">Create</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Friend Info Modal -->
{% if recipient %}
<div class="modal fade" id="friendInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contact Info</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                        style="width:80px; height:80px; color:white; font-size: 2rem;">
                        {{ recipient.display_name[0] | upper }}
                    </div>
                    <h4>{{ recipient.display_name }}</h4>
                    <p class="text-muted">@{{ recipient.username }}</p>
                </div>
                <ul class="list-group list-group-flush text-start">
                    {% if recipient.bio %}
                    <li class="list-group-item">
                        <strong>Bio:</strong> {{ recipient.bio }}
                    </li>
                    {% endif %}
                    <li class="list-group-item">
                        <strong>Email:</strong> {{ recipient.email }}
                    </li>
                    <li class="list-group-item">
                        <strong>Phone:</strong> {{ recipient.phone }}
                    </li>
                    <li class="list-group-item">
                        <strong>Age:</strong> {{ recipient.age }}
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Group Info Modal (Current Group) -->
{% if currentGroup %}
<div class="modal fade" id="groupInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Group Info</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                        style="width:80px; height:80px; color:white; font-size: 2rem;">
                        <i class="fa fa-users"></i>
                    </div>
                    <h4>{{ currentGroup.name }}</h4>
                    <p class="text-muted">{{ currentGroup.description }}</p>
                </div>

                <h6 class="border-bottom pb-2 mb-3">Members ({% if currentGroup.members %}{{
                    currentGroup.members|length
                    }}{% else %}0{% endif %})</h6>
                <div class="list-group list-group-flush" style="max-height: 250px; overflow-y: auto;">
                    {% if currentGroup.members %}
                    {% for member in currentGroup.members %}
                    <div class="list-group-item d-flex align-items-center">
                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3"
                            style="width:36px; height:36px; color:white; font-weight:bold;">
                            {{ member.display_name[0]|upper }}
                        </div>
                        <div>
                            <div class="fw-bold">{{ member.display_name }}</div>
                            <small class="text-muted">@{{ member.username }}</small>
                        </div>
                        {% if member.user_id == currentGroup.creator_id %}
                        <span class="badge bg-warning text-dark ms-auto">Admin</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-muted text-center py-3">No members found.</div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Generic Group Info Modal (For Sidebar) -->
<div class="modal fade" id="genericGroupInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Group Info</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                        style="width:80px; height:80px; color:white; font-size: 2rem;">
                        <i class="fa fa-users"></i>
                    </div>
                    <h4 id="genericGroupName">Group Name</h4>
                    <p class="text-muted" id="genericGroupDesc">Description</p>
                </div>

                <h6 class="border-bottom pb-2 mb-3">Members (<span id="genericMemberCount">0</span>)
                </h6>
                <div class="list-group list-group-flush" id="genericMemberList"
                    style="max-height: 250px; overflow-y: auto;">
                    <div class="text-center text-muted"><i class="fa fa-spinner fa-spin"></i> Loading...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}