{% extends 'base.html' %}

{% block head %}
<title>{{ post['title'] if post else 'Post not found' }}</title>
<style>
    .comment-card {
        transition: all 0.3s ease;
        border-radius: 12px;
    }

    .commenter-link {
        color: #212529 !important;
        font-weight: 600;
        text-decoration: none;
    }

    .commenter-link:hover {
        text-decoration: underline;
        color: #0d6efd !important;
    }

    .mention-link {
        color: #0d6efd !important;
        font-weight: bold;
        text-decoration: none;
    }

    .post-image {
        max-width: 100%;
        height: auto;
        border-radius: 12px;
        margin: 0 auto 15px;
        display: block;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .italic {
        font-style: italic;
    }
</style>
{% endblock %}

{% block body %}
<div class="container mt-4">
    <div class="mb-3">
        <a href="{{ url_for('index') }}" class="text-decoration-none text-muted small">
            <i class="fa fa-arrow-left"></i> Back to Feed
        </a>
    </div>

    <!-- Post Card -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body p-4">
            <h2 class="card-title fw-bold">{{ post['title'] | mention | safe }}</h2>
            <h6 class="text-muted mb-3">
                {% if post['post_type'] == 'daily_prompt' %}
                    <span></span>
                {% else %}
                    By <a href="{{ url_for('userprofile', username=post['display_username']) }}" class="commenter-link">
                        @{{ post['display_username'] }}
                    </a> 
                {% endif %}
                | {{ post['created_at'] }}
            </h6>
            <hr>

            {% if post['image_url'] %}
            <div class="post-image-container text-center mb-4">
                <img src="{{ post['image_url'] }}" class="post-image img-fluid">
            </div>
            {% endif %}

            <p class="card-text fs-5" style="white-space: pre-wrap;">{{ post['content'] | mention | safe }}</p>

            <!-- Event post details (if applicable) -->
            {% if post['post_type'] == 'event' %}
            <hr>
            <div class="event-details mb-3">
                {% if post['location'] %}
                <p><strong>Location:</strong> <a href="https://maps.google.com/?q={{ post['location'] }}"
                        target="_blank">{{ post['location'] }}</a></p>
                {% endif %}
                {% if post['event_date'] and post['event_time'] %}
                <p><strong>When:</strong> {{ post['event_date'] }} at {{ post['event_time'] }}</p>
                {% endif %}
                {% if post['organiser_id'] %}
                <p><strong>Organiser:</strong> <a
                        href="{{ url_for('userprofile', username=post['organiser_username']) }}"
                        class="commenter-link">@{{ post['organiser_username'] }}</a></p>
                {% endif %}
                {% if post['community_id'] %}
                <p><strong>Community:</strong> <a
                        href="{{ url_for('community', community_id=post['community_id']) }}">{{ post['community_name']
                        }}</a></p>
                {% endif %}
            </div>

            <!-- Event registration / chat buttons -->
            {% if not is_registered %}
            <form method="POST" class="d-inline">
                <input type="hidden" name="register_event" value="1">
                <button type="submit" class="btn btn-success me-2">Register</button>
            </form>
            {% else %}
            <span class="badge bg-success me-2">Registered</span>
            {% endif %}

            {% endif %}
        </div>
    </div>

    <!-- Comments Section -->
    <h4>Comments</h4>
    <hr>

    {% if session.get('username') %}
    <form id="commentForm" onsubmit="submitComment(event)" class="mb-4">
        <input type="hidden" name="post_id" id="post_id" value="{{ post['post_id'] }}">
        <div class="mb-2">
            <textarea name="content" class="form-control shadow-sm" rows="3" placeholder="Join the discussion..."
                required></textarea>
        </div>
        <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">Submit Comment</button>
    </form>
    {% endif %}

    <div id="commentsList">
        {% for comment in comments %}
        <div class="card mb-2 shadow-sm comment-card border-0">
            <div class="card-body position-relative">

                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-subtitle text-muted mb-1 small">
                        <a href="{{ url_for('userprofile', username=comment['username']) }}" class="commenter-link">@{{ comment['username'] }}</a>
                        | {{ comment['created_at'] }}
                    </h6>
                    <div class="d-flex align-items-center">
                        {% if session.get('username') == comment['username'] %}
                        <button type="button" class="btn btn-sm text-danger border-0 p-0 me-2"
                            onclick="deleteComment(this, {{ comment['comment_id'] }})">
                            <i class="fa fa-trash"></i>
                        </button>
                        {% endif %}

                        <button type="button"
                            class="btn btn-sm border-0 p-0 d-flex align-items-center {{ 'text-danger' if comment['user_has_liked'] else 'text-muted' }}"
                            onclick="likeComment(this, {{ comment['comment_id'] }})">
                            <i class="fa fa-heart me-1"></i>
                            <span class="like-count small">{{ comment['like_count'] if comment['like_count'] > 0 else '' }}</span>
                        </button>
                    </div>
                </div>
                <div class="card-text mb-2">{{ comment['content'] | mention | safe }}</div>
            </div>
        </div>
        {% else %}
        {% if not locked_view %}
        <p class="text-muted italic px-2">No comments yet. Be the first to say something!</p>
        {% endif %}
        {% endfor %}

        {% if locked_view %}
        <div class="text-center p-4 mt-3" 
            style="background-color: #fff5f5; border: 1px dashed #8B0000; border-radius: 12px;">
            <div class="d-inline-block" style="color: #8B0000;">
                <h5 class="mb-2 fw-bold">
                    <i class="fa fa-lock me-2"></i>Comments Hidden
                </h5>
                <p class="small mb-0 opacity-75">
                    Share your answer to this prompt to see what everyone else wrote!
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
<script>
    function deleteComment(btnElement, commentId) {
        if (!confirm('Are you sure you want to delete this comment?')) return;

        fetch(`/delete_comment/${commentId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const card = btnElement.closest('.comment-card');
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.remove();
                    }, 300);
                } else {
                    alert(data.message || 'Error deleting comment');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the comment.');
            });
    }

    function likeComment(btnElement, commentId) {
        // Prevent clicking if not logged in (optional check, better handled by server/redirect)
        {% if not session.get('username') %}
        alert('Please login to like comments.');
        return;
        {% endif %}

        fetch(`/like_comment/${commentId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const icon = btnElement.querySelector('i');
                    const countSpan = btnElement.querySelector('.like-count');

                    if (data.liked) {
                        btnElement.classList.remove('text-muted');
                        btnElement.classList.add('text-danger');
                    } else {
                        btnElement.classList.add('text-muted');
                        btnElement.classList.remove('text-danger');
                    }

                    countSpan.textContent = data.new_count > 0 ? data.new_count : '';
                } else {
                    alert(data.message || 'Error processing like');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function submitComment(event) {
        event.preventDefault();
        const form = event.target;
        const content = form.content.value;
        const postId = form.post_id.value;
        const submitBtn = form.querySelector('button[type="submit"]');

        if (!content.trim()) return;

        submitBtn.disabled = true;

        fetch(`/add_comment/${postId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: content })
        })
            .then(response => response.json())
            .then(data => {
                submitBtn.disabled = false;
                if (data.status === 'success') {
                    form.reset();

                    const commentsList = document.getElementById('commentsList');
                    const noCommentsMsg = commentsList.querySelector('.text-muted.italic');
                    if (noCommentsMsg) {
                        noCommentsMsg.remove();
                    }

                    const newCommentHtml = `
            <div class="card mb-2 shadow-sm comment-card border-0" style="opacity: 0; transition: opacity 0.5s;">
                <div class="card-body position-relative">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-subtitle text-muted mb-1 small">
                            <a href="/userprofile/${data.username}" class="commenter-link">@${data.username}</a> 
                            | ${data.created_at}
                        </h6>
                            <div class="d-flex align-items-center">
                                <button type="button" class="btn btn-sm text-danger border-0 p-0 me-2" onclick="deleteComment(this, ${data.comment_id})">
                                    <i class="fa fa-trash"></i>
                                </button>
                                <button type="button" class="btn btn-sm border-0 p-0 d-flex align-items-center text-muted" 
                                        onclick="likeComment(this, ${data.comment_id})">
                                    <i class="fa fa-heart me-1"></i>
                                    <span class="like-count small"></span>
                                </button>
                            </div>
                    </div>
                    <div class="card-text mb-2">${data.formatted_content}</div>
                </div>
            </div>`;

                    commentsList.insertAdjacentHTML('afterbegin', newCommentHtml);

                    // Trigger reflow for transition
                    const newCard = commentsList.firstElementChild;
                    void newCard.offsetWidth;
                    newCard.style.opacity = '1';

                } else {
                    alert(data.message || 'Error posting comment');
                }
            })
            .catch(error => {
                submitBtn.disabled = false;
                console.error('Error:', error);
            });
    }
</script>
{% endblock %}