{% extends "base.html" %}

{% block body %}
<div class="container py-4">

    <h2 class="mb-4 fw-semibold">Games</h2>

    <!-- ================= START GAME BUTTON ================= -->
    <button class="btn btn-primary px-4 mb-4"
            data-bs-toggle="modal"
            data-bs-target="#inviteModal">
        Invite Friend
    </button>

    <!-- ================= INVITE MODAL ================= -->
    <div class="modal fade" id="inviteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content rounded-4 shadow">

                <div class="modal-header border-0">
                    <h5 class="modal-title fw-semibold">Invite a Friend</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Select Game</label>
                        <select class="form-select" id="gameTypeSelect">
                            <option value="tictactoe">Tic-Tac-Toe</option>
                            <option value="ludo">Ludo</option>
                        </select>
                    </div>

                    {% if contacts %}
                        <ul class="list-group list-group-flush">
                            {% for friend in contacts %}
                                <li class="list-group-item d-flex align-items-center justify-content-between">
                                    <div>
                                        <input type="radio"
                                               name="opponent"
                                               class="friend-radio me-2"
                                               value="{{ friend.friend_id }}">
                                        {{ friend.display_name }}
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0">You have no friends added yet.</p>
                    {% endif %}
                </div>

                <div class="modal-footer border-0">
                    <button class="btn btn-success px-4"
                            id="startGameBtn">
                        Send Invite
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- ================= INCOMING INVITES ================= -->
    <div class="mb-5">
        <h5 class="fw-semibold mb-3">Incoming Invites</h5>
        <ul id="pendingInvites" class="list-group">
            {% for invite in pending_invites %}
            <li class="list-group-item d-flex justify-content-between align-items-center"
                id="invite_{{ invite.invite_id }}">
                <span>
                    <strong>{{ invite.sender_name }}</strong>
                    invited you to play {{ invite.game_type }}
                </span>
                <div>
                    <a href="/accept_invite/{{ invite.invite_id }}"
                       class="btn btn-sm btn-success me-2">Accept</a>
                    <a href="/decline_invite/{{ invite.invite_id }}"
                       class="btn btn-sm btn-outline-danger">Decline</a>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- ================= OUTGOING INVITES ================= -->
    <div>
        <h5 class="fw-semibold mb-3">Outgoing Invites</h5>
        <ul id="outgoingInvites" class="list-group">
            {% for invite in outgoing_invites %}
            <li class="list-group-item d-flex justify-content-between align-items-center"
                id="invite_{{ invite.invite_id }}">
                <span>
                    Waiting for <strong>{{ invite.receiver_name }}</strong>
                    ({{ invite.game_type }})
                </span>
                <a href="/cancel_invite/{{ invite.invite_id }}"
                   class="btn btn-sm btn-outline-secondary">
                   Cancel
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- ================= LUDO LOBBY (DYNAMIC) ================= -->
    <div id="ludoLobby" class="mt-5" style="display:none;">
        <h5 class="fw-semibold mb-3">Ludo Lobby</h5>
        <ul id="ludoPlayers" class="list-group mb-3">
            <!-- Player slots will be populated via Socket.IO -->
        </ul>
        <button id="startLudoBtn" class="btn btn-primary" disabled>Start Ludo</button>
    </div>

</div>

<!-- ================= SOCKET + JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>

<script>
const socket = io();

/* ================= USER ROOM JOIN ================= */
socket.emit('join_user_room', {
    user_id: {{ session['user_id'] }}
});

/* ================= AUTO REDIRECT WHEN GAME STARTS ================= */
socket.on('game_started', payload => {
    if (payload.game_id) {
        window.location.href = `/game/${payload.game_id}`;
    }
});

/* ================= HANDLE NEW INCOMING INVITE ================= */
socket.on('new_invite', data => {
    const li = document.createElement('li');
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.id = `invite_${data.invite_id}`;

    li.innerHTML = `
        <span>
            <strong>${data.sender_name}</strong>
            invited you to play ${data.game_type}
        </span>
        <div>
            <a href="/accept_invite/${data.invite_id}"
               class="btn btn-sm btn-success me-2">Accept</a>
            <a href="/decline_invite/${data.invite_id}"
               class="btn btn-sm btn-outline-danger">Decline</a>
        </div>
    `;

    document.getElementById('pendingInvites').appendChild(li);
});

/* ================= INVITE REMOVED / HANDLED ================= */
socket.on('invite_handled', data => {
    const el = document.getElementById(`invite_${data.invite_id}`);
    if (el) el.remove();
});

socket.on('invite_cancelled', data => {
    const el = document.getElementById(`invite_${data.invite_id}`);
    if (el) el.remove();
});

/* ================= SEND INVITE ================= */
document.getElementById('startGameBtn').addEventListener('click', async () => {
    const selectedFriend = document.querySelector('.friend-radio:checked');
    const gameType = document.getElementById('gameTypeSelect').value;

    if (!selectedFriend) {
        alert("Select a friend first.");
        return;
    }

    const btn = document.getElementById('startGameBtn');
    btn.disabled = true;
    btn.innerText = "Sending...";

    try {
        const response = await fetch(`/invite_game/${selectedFriend.value}/${gameType}`);
        const data = await response.json();

        if (!data.duplicate) {
            btn.innerText = "Waiting for response...";
        } else {
            btn.innerText = "Already invited.";
        }

    } catch (error) {
        console.error(error);
        btn.innerText = "Error";
        btn.disabled = false;
    }
});

/* ================= LUDO LOBBY ================= */
socket.on('ludo_lobby_update', data => {
    const lobby = document.getElementById('ludoLobby');
    lobby.style.display = 'block';

    const playerList = document.getElementById('ludoPlayers');
    playerList.innerHTML = ''; // clear current list

    data.players.forEach(p => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = p.display_name + (p.ready ? ' âœ…' : '');
        playerList.appendChild(li);
    });

    // Enable start button only if current user is host
    const startBtn = document.getElementById('startLudoBtn');
    startBtn.disabled = !data.is_host;
});

document.getElementById('startLudoBtn').addEventListener('click', () => {
    socket.emit('start_ludo_game');
});

</script>

{% endblock %}
